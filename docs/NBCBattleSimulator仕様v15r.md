# NBCBattleSimulator仕様v15r

## 概要

このソフトウェアはWebアプリとして動作する。
このソフトウェアはMORK BORGというTRPGシステムの派生である『信長の黒い城』TRPGの戦闘の勝率を算出するツールである。
このソフトウェアのタイトルは"信長の黒い城戦闘シミュレータ"です。

## 機能

『信長の黒い城』TRPG(以降NKと呼称)のルールに従い、複数のチームに分かれてそれぞれが敵対チームの殲滅もしくは敗走を目指す。
チーム設定を完了したのち、何回戦闘を行うかを入力する。
入力した回数の戦闘を行い、結果の集計を表示する。

## チーム

チームは最大4チーム参加可能とする。
チームはそれぞれ"A","B","C","D"とする。
チームはプレイヤーチームとNPCチームの二種類の性格がある。
"A"は常にプレイヤーチームとする。
"B","C","D"はNPCチームとする。
プレイヤーチームとNPCチームは攻撃判定方法が異なる。
チーム毎にどのチームと敵対関係か設定できる。
チームは自分の手番に自分の攻撃回数同じ回数攻撃を行う。

## ダイスロール

以下はダイスロールの表記である。

フォーマット
[ダイス数]D[ダイス面数]

例
3D6は3回1-6の範囲のランダムな数を生成して、それぞれの結果を合計する。

## 判定ロール

フォーマット

```planetext
[能力値]DR[必要ダイスロール][ダイスロール補正]
```

例

心DR12-3はD20をロールし[心]の能力値を加算し-3を引く。結果が12以上なら成功。

### 戦闘状況設定

このアプリの使用者（以降ユーザーと呼称する）は戦闘状況として以下を入力する。

チーム数：最低2から最大4

チームAの敵対チーム
チームBの敵対チーム
チームCの敵対チーム
チームDの敵対チーム
チームAの内訳
チームBの内訳
チームCの内訳
チームDの内訳

チームメンバーをリストから削除できること。

### チームの内訳

それぞれのチームの内訳をリストから選んで追加する。
内訳の最初のメンバーはリーダーとみなす。
リーダーは士気判定の際の条件になる。

#### メンバーリスト

| メンバー名称 | 説明 |
| ------------ | ------------------ |
| PCランダム | 能力と武装をランダムに決定 |
| NPCランダム | 能力と武装をランダムに決定、PCと同様の人間を敵対する場合のメンバーで能力値や武装をPCと同様にランダムで決定する |
| PC指定 | メンバーエディタで作成したメンバーを追加 |
| NPC指定 | メンバーエディタで作成したメンバーを追加 |
| 足軽ファランクス | 敵対チームのメンバー |
| 百足衆 | 敵対チームのメンバー |
| ろくろ首 | 敵対チームのメンバー |
| 河童水軍 | 敵対チームのメンバー |
| 鬼 | 敵対チームのメンバー |
| 黒母衣戦象 | 敵対チームのメンバー |
| 黒茶頭 | 敵対チームのメンバー |
| 赤母衣髑髏 | 敵対チームのメンバー |
| 亡霊武者 | 敵対チームのメンバー |
| 禿ネズミ武将 | 敵対チームのメンバー |
| 第六天魔王信長 | 敵対チームのメンバー |
| 山犬雑兵 | 敵対チームのメンバー |
| 鎌鼬 | 敵対チームのメンバー |
| 生臭坊主 | 敵対チームのメンバー |
| 槍かつぎのやせがえる | 敵対チームのメンバー |
| 足軽兎 | 敵対チームのメンバー |
| のっぺら荒武者 | 敵対チームのメンバー |
| 鉄砲猩々 | 敵対チームのメンバー |
| 鉄騎猪 | 敵対チームのメンバー |
| くのいち狐 | 敵対チームのメンバー |
| 弾正狸 | 敵対チームのメンバー |
| からくり巴 | 敵対チームのメンバー |
| 烏天狗 | 敵対チームのメンバー |

##### チーム"A"の攻撃方法について

チーム"A"のメンバーは自分の手番に、所持している武器からランダムに１つを選びその武器で敵対チームのランダムなメンバーを1回攻撃します。

##### 敵対チームのメンバーの攻撃方法

[攻撃0] 初回のターンの攻撃方法
[攻撃1] 初回以外での最初のターンでの攻撃
[攻撃2] 初回以外での次のターンの攻撃
[攻撃3] 初回以外での３番目のターンの攻撃
[攻撃4] 初回以外での４番目のターンの攻撃
攻撃1,攻撃2,攻撃3,攻撃4のように0以外の数字がある場合最後の番号の攻撃の後は1に戻って繰り返す。これらはターン経過ごとに切り替わるサイクル（1ターン目：攻撃1、2ターン目：攻撃2…）です。
[攻撃E] そのメンバーが死亡した場合にターン終了時に攻撃する。
[攻撃R] 弾薬が尽きた場合や、武器が壊れた場合の攻撃手段。他に攻撃手段がなくなったときの予備攻撃手段。
攻撃の後にn回と書かれている場合、同じターンに連続してn回攻撃をすることを示しています。

##### 敵対チームのメンバーの詳細

詳細は [NBCBattleSimulator_EnemyMembers.md](NBCBattleSimulator_EnemyMembers.md) を参照。

#### メンバーエディタ

追加するメンバーを予め登録する機能。
メンバー内訳設定時に登録したメンバーを呼び出せる。
メンバーエディタではPCの能力値と装備を設定できる。
装備は装備一覧から登録する。

### プレイヤーチームのメンバー

プレイヤーチームのメンバーは以下の能力を持つ

#### 能力値

[心]
[技]
[体]
[耐久]
[HP]

#### 能力値決定方法

[心],[技],[体]は以下の方法で能力を決定する。
3D6をロールし

| 3D6 | 能力値 |
| :----: | :-----: |
| 1-4 | -3 |
| 5-6 | -2 |
| 7-8 | -1 |
| 9-12 | 0 |
| 13-14 | +1 |
| 15-16 | +2 |
| 17-18 | +3 |

[HP]は1D8+耐久(最低1)で決定する。

#### プレイヤーチームの所持品決定

プレイヤーチームのそれぞれのメンバーは所持品を以下の表を１回使用して決定する。
全ての武器が破損した場合、"素手"による攻撃を行う。"素手"は破損しない。

| 1D12 | 所持品名称 |
| --- | --- |
| 1 | "尖らせた骨の杭" |
| 2 | "竹槍" |
| 3 | "百姓から奪った鍬" |
| 4 | "脇差し" |
| 5 | "手裏剣" |
| 6 | "刀" |
| 7 | "鎖鎌" |
| 8 | "太刀" |
| 9 | "種子島銃" |
| 10 | "大槍" |
| 11 | "爆裂弾" |
| 12 | "斬馬刀" |

#### プレイヤーチームの鎧決定

プレイヤーチームのそれぞれのメンバーは鎧レベルを以下の表を1回使用して決定する。

| 1D6 | 鎧レベル |
| --- | --- |
| 1 | 0 |
| 2 | 0 |
| 3 | 1 |
| 4 | 2 |
| 5 | 3 |
| 6 | 4 |

#### 鎧と鎧レベル

鎧は敵の攻撃が命中した際に、ダメージを軽減する。

| 鎧レベル | ダメージ軽減 |
| --- | --- |
| 0 | 0 |
| 1 | -1D2 |
| 2 | -1D3 |
| 3 | -1D4 |
| 4 | -1D6 |

攻撃がクリティカルヒットであった場合、攻撃を受けた相手の鎧レベルが1レベル下がる。
プレイヤーチームのメンバーで防御判定がファンブルだった場合鎧レベルが1レベル下がる。

敵チームメンバーには鎧レベルではなくダイスロールが設定されているものがある。
その場合、常にそのダイスロールをダメージ補正として用い、クリティカルやファンブルのレベル減少を起こさない。

#### チームメンバーの武装

チームメンバーは最低１種類の武装を持つ。
一人のメンバーが複数の武装を持つ場合がある。
複数の武装を持つメンバーは攻撃順序が決められている場合がある。
武装名称の後に番号がある場合ターン毎に番号順に攻撃を繰り返す。
武装名の後に0とある場合は最初のターンのみ使用する。
武装名の後にEとある場合はターン終了時に特別行動として使用する。
武装名の後になにも書かれていない場合はターン毎にランダムに使用する。

##### 武装のパラメータ

武装には以下のパラメータがある。

```planetext
[名称]:その武装の名称
[種類]:近接武器もしくは射撃武器
[命中判定]:プレイヤーが命中させる際に補正に使う能力
[被命中判定]:プレイヤーが敵に攻撃された際に補正に使う能力
[ダメージ]:命中した場合に相手に与えるダメージ
[弾数]:使用できる回数、-1の場合は無限に使用可能
```

##### 武器の種類

```planetext
近接武器:近距離から敵へ攻撃する
射撃武器:遠距離から敵へ攻撃する
範囲武器:範囲内にいる敵を攻撃する
敗走判定強制:使用したチームのターン終了時に相手チームの敗走判定を行う。
```

##### 武装の種類の一覧

詳細は [NBCBattleSimulator_WeaponList.md](NBCBattleSimulator_WeaponList.md) を参照。

###### 状態異常

詳細は [NBCBattleSimulator_StatusEffects.md](NBCBattleSimulator_StatusEffects.md) を参照。

##### 対象攻撃時の特別ルール

詳細は [NBCBattleSimulator_SpecialRules.md](NBCBattleSimulator_SpecialRules.md) を参照。

##### 攻撃対象選定方法

詳細は [NBCBattleSimulator_TargetSelection.md](NBCBattleSimulator_TargetSelection.md) を参照。

## 戦闘

それぞれのチームは１ターンにイニシアチブが高いものから順番に攻撃を行う。
ターンの最後に１チームだけが存在する状態になったら１回の戦闘は終了したものとみなすし結果を保存する。
ターン数が100に達した場合、戦闘は終了する（引き分け/時間切れ）。

### 戦闘手順

1. イニシアチブ決定
2. チーム毎手番処理
3. 敵対チームの殲滅または敗走チェック
4. ターン終了

#### イニシアチブ決定

チーム毎に1D6を振り、その値をイニシアチブとする。
チームにイニシアチブ補正があるならその値を加える。
同じ値のチームがある場合、その順序は不定（実装依存）とする。
最もイニシアチブが高いチームの手番から順番にチーム毎手番処理を行う。

#### チーム毎手番処理

チームの各メンバーは以下の手順で攻撃を行う。

1. 攻撃対象選定
2. 攻撃

特殊攻撃がある場合、その特殊攻撃を実行する。

#### 攻撃対象選定

攻撃対象選定種別にしたがって攻撃対象を決定する。

### 敵対チームの殲滅または敗走チェック

同じチームのメンバーのうち、全員死亡または敗走した場合。そのチームは以降戦闘に参加しない。

#### 敗走判定の条件

チーム"A"以外のチームは以下の条件のどれかを満たすとき敗走チェックを行う
チームのリーダーが死亡した。
チームの半数が死亡した。
一人だけのチームの場合HPが３割以下になった。

#### 敗走判定と結果

2D6をロールし、生き残っているチームメンバーのうち最も高い士気のメンバーの値を超えた場合。そのチーム全体に以下の結果を適用する。
1D6し1-3:敗走,4-6:降伏

#### 攻撃

```planetext
人間型メンバーの場合、所持している武器の中からランダムに1つ選んで攻撃する。
人間型メンバーは１回の手番で１回だけ攻撃する。
攻撃判定は武器の[命中判定]の内容を利用する。
人間型メンバーは[命中判定]がなしの武器を利用できない。
もし人間型のメンバーが[命中判定]がなしの武器を所持している場合、エラーを出す。
人間型以外のメンバーは、敵対チームのメンバーの攻撃方法 に記載した内容で攻撃を行う。
人間型メンバーが非人間型メンバーへ攻撃した場合、人間型メンバーの[命中判定]として命中を判定する。
被人間型メンバーが人間型メンバーへ攻撃した場合。非人間型メンバーの[非命中判定]として命中を判定する。

攻撃判定は1D20で判定する。
判定の詳細は、各武器の[命中判定]もしくは[非命中判定]の内容にしたがう。

人間型メンバーが攻撃判定する際に修正前のダイスロールが20の場合クリティカルとみなす。
人間型メンバーが攻撃判定する際に修正前のダイスロールが1の場合ファンブルとみなす。
攻撃がクリティカルの場合、ダメージが２倍になり、相手の鎧レベルを1レベル低下させる。
攻撃がファンブルの場合、攻撃したメンバーの武器を使用不能にする。

人間型メンバーが防御判定する際に修正前のダイスロールが20の場合クリティカルとみなす。
人間型メンバーが攻撃判定する際に修正前のダイスロールが1の場合ファンブルとみなす。
防御がクリティカルの場合、相手に対して１回攻撃できる。
防御がファンブルの場合、ダメージが２倍になり、鎧が１レベル低下する。
```

##### HPが0以下になった場合

人間型メンバーのHPが0になった場合、そのメンバーは重症状態となる。
直ちに1D4をロールして以下の結果に従う

| 1D4 | 結果 |
| --- | --- |
| 1 | 1D4ラウンド意識不明、そのごHPに1D4をプラスする |
| 2 | 1D4ラウンド意識不明、そのごHPに1D4をプラスする |
| 3 | 出血状態、ただし戦闘には影響なし |
| 4 | 死亡 |

HPが-1以下になった場合は死亡する。

人間型以外のメンバーはHP0で死亡する。

### 戦闘結果

以下を記録する。
チーム"A"の開始時生存者数
チーム"A"の終了時生存者数
チーム"A"以外の開始時生存者数
チーム"A"以外の終了時生存者数
チーム"A"以外の逃走者数

### 最終戦闘結果

#### 中間データ

最終戦闘結果計算用の中間データ。

チーム"A"の開始時生存者数の合計
チーム"A"の終了時生存者数の合計
チーム"A"以外の開始時生存者数の合計
チーム"A"以外の終了時生存者数の合計
チーム"A"以外の逃走者数の合計

#### 結果

各チームは以下の値を計算する。
チームの生存率 = チームの終了時生存者数の合計 / チームの開始時生存者数の合計
チームの逃走率 = チームの逃走者数の合計 / チーム開始時生存者数の合計
各チームの勝率 = 各チームが時間切れ以外で最後まで残った回数 / 各チームの戦闘参加回数

この結果を表示する。

## 攻撃対象選定種別

## 業(gou)について

業は人間型メンバーが持つ、サポートポイントである。
作成したキャラクターは業2ポイントで開始します。

業1ポイントでできることは以下の通り

* 使用したメンバーの1回の攻撃で最大のダメージを与える（実装では固定の大きな値（10等）をダメージとする）
* 他の敵チームを含む他のメンバーのロールをやり直す
* 仕様したメンバーのダメージを1D6下げる
* 他の敵チームを含む他のメンバーのクリティカルまたはファンブルを打ち消す（防具破損、武器の損壊、カウンター攻撃、ダメージ２倍をなくす）
* 使用者の判定ダイスロールの結果を+4する。重複しても良い

## チームAの人数指定オプション

この機能は、チームAについて、人数だけを指定して毎回メンバーをクリアして、人数分をランダムに選んでメンバーを追加する機能です。
このオプションにより、様々な構成メンバーで敵と対峙した際の勝率を確認することができます。

## バージョン表示機能

画面タイトルの下に、現在のバージョンを表示する。

現在のバージョンは,1.4.1とする。

## 戦闘条件ファイルの読み込みと戦闘結果のファイル出力

この機能は、戦闘条件を記したcsv形式のファイルを読み込み、戦闘を実行した後、戦闘結果を記したcsv形式のファイルに出力する機能です。

* 戦闘条件ファイルはユーザーが指定できる。
* 戦闘結果はユーザーがダウンロードする形で出力する。
* チームAの敵対チームは常にチームBとする。
* チームBの敵対チームは常にチームAとする。
* **この機能はPC版（画面幅が一定以上の環境）でのみ提供し、スマートフォン版では非表示または使用不可とする。**

### 戦闘条件ファイルのフォーマット

デリミターはカンマとする。

\# で始まる行はコメント行とみなす。

試行回数,チームAの人数,チームBのモンスター名,チームBのモンスター数

### 戦闘結果ファイルのフォーマット

デリミターはカンマとする。

\# で始まる行はコメント行とみなす

試行回数,チームAの人数,チームBのモンスター名,チームBのモンスター数,チームAの勝率,チームAの生存率,チームBの勝率,チームBの敗走/逃走率

## スマートフォン対応（レスポンシブWebアプリ化）

この機能は、Webアプリをスマートフォン（iPhone/Android）の画面サイズに対応させるものである。
単一のコード（リポジトリ）でPC版とスマートフォン版の両方に対応する。

### 実装要件

* **レスポンシブレイアウト**: 画面幅に応じてレイアウトを調整する。
  * PC版で2列表示などのレイアウトを、スマートフォン版では1列表示に切り替えるなど、画面幅に最適化する。
  * CSSメディアクエリを使用して実装する。
* **タッチ操作対応**: スマートフォンでの操作性を考慮する。
  * ボタンや入力フォームなどのタップ領域を、指で操作しやすいサイズ（44px以上推奨）に拡大・調整する。
* **フォントサイズ調整**: スマートフォンの画面サイズに合わせて文字サイズを適切に調整する。
  * PC向けの大きな見出しなどは、スマートフォンでは適切なサイズに縮小する。
